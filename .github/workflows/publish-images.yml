name: Publish Context8 Docker Images

on:
  push:
    tags:
      - "v*"

permissions:
  contents: read
  packages: write

jobs:
  publish:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - service: api
            context: ./backend
            dockerfile: ./backend/Dockerfile
          - service: frontend
            context: ./frontend
            dockerfile: ./frontend/Dockerfile
          - service: embedding
            context: ./embedding
            dockerfile: ./embedding/Dockerfile

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate release tag
        id: tag
        shell: bash
        run: |
          set -euo pipefail
          tag="${GITHUB_REF_NAME}"
          if [[ ! "$tag" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Tag must follow semantic version format: v<major>.<minor>.<patch> (example: v1.2.3)"
            exit 1
          fi
          major="$(echo "$tag" | cut -d. -f1)"
          minor="$(echo "$tag" | awk -F. '{print $1"."$2}')"

          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "major=$major" >> "$GITHUB_OUTPUT"
          echo "minor=$minor" >> "$GITHUB_OUTPUT"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate Docker Hub credentials
        shell: bash
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [[ -z "${DOCKERHUB_USERNAME}" || -z "${DOCKERHUB_TOKEN}" ]]; then
            echo "::error::Missing DOCKERHUB_USERNAME or DOCKERHUB_TOKEN secrets."
            exit 1
          fi

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push ${{ matrix.service }}
        if: matrix.service != 'frontend'
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: true
          tags: |
            ghcr.io/context8/context8-docker-${{ matrix.service }}:${{ steps.tag.outputs.tag }}
            ghcr.io/context8/context8-docker-${{ matrix.service }}:${{ steps.tag.outputs.minor }}
            ghcr.io/context8/context8-docker-${{ matrix.service }}:${{ steps.tag.outputs.major }}
            ghcr.io/context8/context8-docker-${{ matrix.service }}:latest
            docker.io/${{ secrets.DOCKERHUB_USERNAME }}/context8-docker-${{ matrix.service }}:${{ steps.tag.outputs.tag }}
            docker.io/${{ secrets.DOCKERHUB_USERNAME }}/context8-docker-${{ matrix.service }}:${{ steps.tag.outputs.minor }}
            docker.io/${{ secrets.DOCKERHUB_USERNAME }}/context8-docker-${{ matrix.service }}:${{ steps.tag.outputs.major }}
            docker.io/${{ secrets.DOCKERHUB_USERNAME }}/context8-docker-${{ matrix.service }}:latest

      - name: Build and push frontend
        if: matrix.service == 'frontend'
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: true
          build-args: |
            VITE_API_BASE=http://localhost:8000
          tags: |
            ghcr.io/context8/context8-docker-${{ matrix.service }}:${{ steps.tag.outputs.tag }}
            ghcr.io/context8/context8-docker-${{ matrix.service }}:${{ steps.tag.outputs.minor }}
            ghcr.io/context8/context8-docker-${{ matrix.service }}:${{ steps.tag.outputs.major }}
            ghcr.io/context8/context8-docker-${{ matrix.service }}:latest
            docker.io/${{ secrets.DOCKERHUB_USERNAME }}/context8-docker-${{ matrix.service }}:${{ steps.tag.outputs.tag }}
            docker.io/${{ secrets.DOCKERHUB_USERNAME }}/context8-docker-${{ matrix.service }}:${{ steps.tag.outputs.minor }}
            docker.io/${{ secrets.DOCKERHUB_USERNAME }}/context8-docker-${{ matrix.service }}:${{ steps.tag.outputs.major }}
            docker.io/${{ secrets.DOCKERHUB_USERNAME }}/context8-docker-${{ matrix.service }}:latest
